<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>E-form</title>

    <script src="../../../lib/jquery/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="../../editor/_.css" rel="stylesheet" />
    <link href="../../editor/_.js" rel="stylesheet" />


</head>

<body>

    <div class="main-modal fixed w-full h-100 inset-0 z-50 overflow-hidden flex justify-center items-center animated fadeIn faster"
        style="background: rgba(0,0,0,.7);">
        <div
            class="border border-teal-500 shadow-lg modal-container bg-white w-full md:max-w-4xl mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <!--Title-->
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">ตัวอย่างเอกสาร</p>
                    <div class="modal-close cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 18 18">
                            <path
                                d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
                            </path>
                        </svg>
                    </div>
                </div>
                <!--Body-->
                <div class="my-5">
                    <iframe id="e_formController_pdf_preview" frameborder="0" height="750" width="100%">
                    </iframe>
                </div>
                <!--Footer-->
                <div class="flex justify-end pt-2">
                    <button
                        class="focus:outline-none modal-close px-4 bg-gray-400 p-3 rounded-lg text-black hover:bg-gray-300">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div>
        <div class="m-in " style="padding-top: 0px !important">
            <form name="sent_form" method="post" id="form">
                <div class=" justify-content-center text-center py-5 ">
                    <input type="submit" class="p-3 bg-blue-500 text-white hover:bg-blue-400" value="Export">
                    <input type="text" hidden name="action" value="preview">
                </div>
                <span id="block_tab_1" style="display: inline">
                    <page size="A4" id="page0">
                        <div class="memo-form">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tbody>
                                    <tr>
                                        <td align="left" valign="top">
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                <tbody>
                                                    <tr>
                                                        <td width="30%" align="left" valign="top">
                                                            <img src="../../../images/memo.png" />
                                                        </td>
                                                        <td width="40%" align="left" valign="top">
                                                            <table width="100%" border="0" cellspacing="0"
                                                                cellpadding="0">
                                                                <tbody>
                                                                    <tr>
                                                                        <td align="center" valign="top">
                                                                            <div class="text-29pt">
                                                                                บันทึกข้อความ
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </td>
                                                        <td width="30%" align="center" valign="top">
                                                            &nbsp;
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" valign="top">
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                <tbody>
                                                    <tr>
                                                        <td align="left" valign="top" class="p-8">
                                                            <table width="100%" border="0" cellspacing="0"
                                                                cellpadding="0">
                                                                <tbody>
                                                                    <tr>
                                                                        <td align="left" valign="bottom">
                                                                            <table width="100%" border="0"
                                                                                cellspacing="0" cellpadding="0">
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td width="15%" align="left"
                                                                                            valign="bottom">
                                                                                            <div
                                                                                                class="letter-head-memo">
                                                                                                ส่วนราชการ
                                                                                            </div>
                                                                                        </td>
                                                                                        <td width="85%" align="left"
                                                                                            valign="bottom"
                                                                                            class="memo-border-bottom">
                                                                                            <input type="text"
                                                                                                class="w-full  py-2 border border-slate-300"
                                                                                                name="government"
                                                                                                id="government" value=""
                                                                                                onblur="checkVal(this)"
                                                                                                autocomplete="off" />
                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td align="left" valign="top" class="p-8">
                                                            <table width="100%" border="0" cellspacing="0"
                                                                cellpadding="0">
                                                                <tbody>
                                                                    <tr>
                                                                        <td align="left" valign="bottom">
                                                                            <table width="100%" border="0"
                                                                                cellspacing="0" cellpadding="0">
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td width="2%" align="left"
                                                                                            valign="bottom">
                                                                                            <div
                                                                                                class="letter-head-memo">
                                                                                                ที่
                                                                                            </div>
                                                                                        </td>
                                                                                        <td width="47%" align="center"
                                                                                            valign="bottom"
                                                                                            class="memo-border-bottom">
                                                                                            <input type="text"
                                                                                                class="w-full  py-2 border border-slate-300"
                                                                                                name="at" id="at"
                                                                                                value=""
                                                                                                onblur="checkVal(this)"
                                                                                                autocomplete="off" />
                                                                                        </td>
                                                                                        <td width="6%" align="center"
                                                                                            valign="bottom">
                                                                                            <div
                                                                                                class="letter-head-memo">
                                                                                                วันที่
                                                                                            </div>
                                                                                        </td>
                                                                                        <td width="45%" align="center"
                                                                                            valign="bottom"
                                                                                            class="memo-border-bottom"
                                                                                            style="padding-left: 20px">
                                                                                            <input type="text"
                                                                                                class="w-full  py-2 border border-slate-300"
                                                                                                name="date" id="date"
                                                                                                value=""
                                                                                                onblur="checkVal(this)"
                                                                                                autocomplete="off" />
                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td align="left" valign="top" class="p-8">
                                                            <table width="100%" border="0" cellspacing="0"
                                                                cellpadding="0">
                                                                <tbody>
                                                                    <tr>
                                                                        <td align="left" valign="bottom">
                                                                            <table width="100%" border="0"
                                                                                cellspacing="0" cellpadding="0">
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td width="8%" align="left"
                                                                                            valign="bottom"
                                                                                            class="letter-head-memo">
                                                                                            เรื่อง
                                                                                        </td>
                                                                                        <td width="92%" align="left"
                                                                                            valign="bottom"
                                                                                            class="memo-border-bottom">
                                                                                            <input
                                                                                                class="w-full  py-2 border border-slate-300"
                                                                                                type="text"
                                                                                                name="subject" value=""
                                                                                                id="subject"
                                                                                                autocomplete="off"
                                                                                                onblur="checkVal(this)" />
                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td align="left" valign="top" class="p-8">
                                                            <table width="100%" border="0" cellspacing="0"
                                                                cellpadding="0">
                                                                <tbody>
                                                                    <tr>
                                                                        <td align="left" valign="bottom">
                                                                            <table width="100%" border="0"
                                                                                cellspacing="0" cellpadding="0">
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td width="8%" align="left"
                                                                                            valign="bottom"
                                                                                            class="letter-head-memo"
                                                                                            style="font-size: 16pt">
                                                                                            เรียน
                                                                                        </td>
                                                                                        <td width="92%" align="left"
                                                                                            valign="bottom"
                                                                                            class="memo-border-bottom"
                                                                                            style="border: none">
                                                                                            <input
                                                                                                class="w-full  py-2 border border-slate-300"
                                                                                                type="text"
                                                                                                onblur="checkVal(this)"
                                                                                                name="learn" id="learn"
                                                                                                value=""
                                                                                                autocomplete="off" />
                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <span class="memo_description"> </span>

                            <div class=" row mt-5">
                                <div class="col-lg-12">
                                    <a class="ring-1 ring-slate-900/5 space-y-3 hover:bg-sky-500 hover:ring-sky-500"
                                        href="javascript:;" onclick="addTopic(1);"><strong>+
                                            เพิ่มหัวข้อใหม่</strong></a>
                                    <a class="ring-1 ring-slate-900/5 space-y-3 hover:bg-sky-500 hover:ring-sky-500"
                                        href="javascript:;" onclick="addParagraph(1);"><strong>+
                                            เพิ่มย่อหน้าใหม่</strong></a>
                                    <a class="ring-1 ring-slate-900/5 space-y-3 hover:bg-sky-500 hover:ring-sky-500"
                                        href="javascript:;" onclick="addNewMessage(1);"><strong>+
                                            เพิ่มข้อความใหม่</strong></a>
                                </div>
                            </div>
                        </div>

                        <div class="footer-text">
                            <input class="w-full  py-2 border border-slate-300" autocomplete="off" name="textfooter[0]"
                                id="textfooter" onblur="checkVal(this)" style="height: 48px" />
                        </div>

                    </page>
                    <div class=" text-center py-20 " id="addPage">
                        <div class="col-lg-12">
                            <a href="javascript:;" onclick="addPage();"><strong>+ เพิ่มหน้าใหม่</strong></a>
                        </div>
                    </div>

                    <div class="bg-white  py-5 ">
                        <table border="0" cellspacing="0" cellpadding="0" width="100%">
                            <tr>
                                <td colspan="1" width="50%"> </td>
                                <td valign="top" style="text-align:left;" colspan="2">
                                    <p><span class="c16"><input type="text"
                                                class="w-full  py-2 border border-slate-300 text-center" name="rank"
                                                placeholder="ยศ"></span>
                                    </p>
                                </td>
                                <td valign="top" style="text-align:left;" colspan="1" width="44%">
                                    <p>
                                        <span class="c16"><input class="  py-2 border border-slate-300 text-center"
                                                type="text" name="signature" id="signature" value=""
                                                placeholder="ลายเซ็นต์"></span>
                                    <p><span class="c16"><input class="  py-2 border border-slate-300 text-center"
                                                type="text" name="namesurname" id="namesurname"
                                                placeholder="ชื่อ-นามสกุล"></span></p>
                                    <p><span class="c16"><input class="  py-2 border border-slate-300 text-center"
                                                type="text" name="position" id="position" placeholder="ตำแหน่ง"></span>
                                    </p>
                                    <p><span class="c16"><input class="py-2 border border-slate-300 text-center"
                                                type="text" name="other" id="other" placeholder="อื่นๆ(ถ้ามี)"></span>
                                    </p>
                                    </p>
                            </tr>
                        </table>
                    </div>
                </span>

            </form>
        </div>


    </div>


    <script>

        function addPages(page, name = "description") {
            const parsedData = JSON.parse(sessionStorage.getItem(name)) || [];
            const itemIndex = parsedData[page]

            if (!itemIndex) {
                const newPage = { page: page, data: [] };
                parsedData.push(newPage);
                sessionStorage.setItem(name, JSON.stringify(parsedData));
            }
        }

        function updateMessages(page, id, message, name = "description") {
            // Retrieve the data from sessionStorage
            const sessionData = sessionStorage.getItem(name);
            const data = JSON.parse(sessionData);
            const item = data[page].data.find(item => item.id === id);
            if (item) {
                item.message = message;
                sessionStorage.setItem(name, JSON.stringify(data));
            }
        }


        function deleteObject(page, id, name = "description") {

            // Retrieve the data from sessionStorage
            const sessionData = sessionStorage.getItem(name);
            const data = JSON.parse(sessionData);

            // Delete the item with id "new-id-456" on page 0
            const itemIndex = data[page].data.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                data[page].data.splice(itemIndex, 1);

                // Set the updated data back to sessionStorage
                sessionStorage.setItem(name, JSON.stringify(data));
            }



        }



        function deletePageAndUpdateSessionStorage(currentPage) {
            // Get the description array from sessionStorage
            const description = JSON.parse(sessionStorage.getItem('description'));

            // Check if the description array exists and has more than one page
            if (description && description.length > 1) {
                // Delete the second page from the description array
                description.splice(1, 1);

                // Set the updated description array in sessionStorage
                sessionStorage.setItem('description', JSON.stringify(description));
            }
        }


        function manipulateSessionStorage(pages, id, type = 'p', name = "description") {
            // add an item to sessionStorage
            let description = sessionStorage.getItem(name);

            let newItem = { id: id, type: type, message: '' };

            description = JSON.parse(description);
            description[pages].data.push(newItem);
            sessionStorage.setItem(name, JSON.stringify(description));

        }

    </script>

    <script>
        const modal = document.querySelector('.main-modal');
        const closeButton = document.querySelectorAll('.modal-close');

        const modalClose = () => {
            modal.classList.remove('fadeIn');
            modal.classList.add('fadeOut');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 500);
        }

        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();
            let description = sessionStorage.getItem("description");

            if (!!description) {

                const formData = new FormData(this);
                formData.append("description2", description)

                modal.classList.remove('fadeOut');
                modal.classList.add('fadeIn');
                modal.style.display = 'flex';
                fetchPDF(formData)
            } else {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน')
            }
        });

        const fetchPDF = (formData) => {

            fetch('./pdf.php', {
                method: 'POST',
                headers: {
                    // 'Accept': 'application/json',
                    // 'Content-Type': 'application/json',
                    // 'X-CSRF-TOKEN': _token
                },
                body: formData
            })
                .then(response => response.arrayBuffer())
                .then(result => {

                    var blob = new Blob([result], { type: 'application/pdf' });
                    var fileURL = URL.createObjectURL(blob);

                    // const isMobile = navigator.userAgentData.mobile;
                    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        var newWin = window.open(fileURL);
                        newWin.focus();
                        modalClose();
                    } else {
                        let input_cotton = document.querySelector("#e_formController_pdf_preview");
                        input_cotton.src = fileURL;

                    }

                });


        }


        for (let i = 0; i < closeButton.length; i++) {

            const elements = closeButton[i];

            elements.onclick = (e) => modalClose();

            modal.style.display = 'none';
        }
    </script>
    <script type="text/javascript">

        showDataById();
        function showDataById() {
            let government = sessionStorage.getItem("government");
            let subject = sessionStorage.getItem("subject");
            let learn = sessionStorage.getItem("learn");

            $("#government").val(government);
            $("#subject").val(subject);
            $("#learn").val(learn);

            checksessionStorage(1);

        }


        function checksessionStorage(type = 0) {
            // add an item to sessionStorage
            let name = 'description'
            let description = sessionStorage.getItem(name);


            if (!description) {
                sessionStorage.setItem(name, JSON.stringify([{ page: 0, data: [] }]));
            } else {
                if (type == 1) {
                    sessionStorage.removeItem(name)
                }

            }
        }

        function addParagraph(page) {
            var pages = page - 1;
            let type = 'paragraph';
            let random = Math.floor((Math.random() * 1000) + 1);
            let id = `${type}-id-${random}`;
            checksessionStorage();

            // var blockClone = $("#container_clone").html();
            var selector = $("#page" + pages + " .memo_description")

            var textareaClone = '<span id="container_clone">' +
                '<div id="' + id + '">' +
                '<a href="javascript:;" class="btn   py-2" onclick="deleteVal(this)" data-id="' + id + '" data-page="' + pages + '">X</a>' +
                '<textarea id="' + id + '" type="text" data-page="' + pages + '" autocomplete="off" name="description[' + pages + '][]" onblur="checkVal(this)" rows="5" ' +
                'class="w-full  py-2 border border-slate-300 text-indent-25"></textarea>' +
                '</div>' +
                '</span>';

            selector.append(textareaClone);

            manipulateSessionStorage(pages, id, type)


        }

        function addNewMessage(page) {
            var pages = page - 1;
            let type = 'message';
            let random = Math.floor((Math.random() * 1000) + 1);
            let id = `${type}-id-${random}`;

            // var blockClone = $("#container_clone").html();
            var selector = $("#page" + pages + " .memo_description")

            var textareaClone = '<span id="container_clone">' +
                '<div id="' + id + '">' +
                '<a href="javascript:;" class="btn   py-2" onclick="deleteVal(this)" data-id="' + id + '" data-page="' + pages + '">X</a>' +
                '<textarea id="' + id + '" type="text" data-page="' + pages + '" autocomplete="off" name="description[' + pages + '][]" onblur="checkVal(this)" rows="5" ' +
                'class="w-full  py-2 border border-slate-300 "></textarea>' +
                '</div>' +
                '</span>';

            selector.append(textareaClone);

            manipulateSessionStorage(pages, id, type)


        }


        function addTopic(page) {
            var pages = page - 1;
            let type = 'topic';
            let random = Math.floor((Math.random() * 1000) + 1);
            let id = `${type}-id-${random}`;

            // var blockClone = $("#container_clone").html();
            var selector = $("#page" + pages + " .memo_description")

            var textareaClone = '<span id="container_clone">' +
                '<div id="' + id + '">' +
                '<a href="javascript:;" class="btn   py-2" onclick="deleteVal(this)" data-id="' + id + '" data-page="' + pages + '">X</a>' +
                '<input id="' + id + '" type="text" data-page="' + pages + '" autocomplete="off" name="description[' + pages + '][]" onblur="checkVal(this)" rows="5" ' +
                'class="w-full text-indent-25 font-bold py-2 border border-slate-300"/>' +
                '</div>' +
                '</span>';

            selector.append(textareaClone);

            manipulateSessionStorage(pages, id, type)


        }

        function addPage() {
            var tmp_page = $("#block_tab_1 page").length;
            var page = $("#block_tab_1 page").length + 1;
            var thaiPage = changeThaiNumber(page);
            let name = 'description'
            let description = sessionStorage.getItem(name);
            if (!!description) {
                var html =
                    '<page size="A4" id="page' + tmp_page + '">' +
                    ' <div class="next-page">-' + thaiPage + "-</div>" +
                    '<a href="javascript:;" class="btn px-2 py-2" onclick="deleteValuePage(this)"  data-page="' + tmp_page + '">X</a><div class="row" style="line-height: 30px;"><div class="col-lg-12">' +
                    '<div class="memo-form"><span class="memo_description"></span>' +
                    '<div class=" row mt-5"> <div class="col-lg-12"><a class="ring-1 ring-slate-900/5 space-y-3 hover:bg-sky-500 hover:ring-sky-500" href="javascript:;" onclick="addTopic(' + page + ');"><strong>+ เพิ่มหัวข้อใหม่</strong></a> <a class="ring-1 ring-slate-900/5 space-y-3 hover:bg-sky-500 hover:ring-sky-500" href="javascript:;" onclick="addParagraph(' + page + ');"><strong>+ เพิ่มย่อหน้าใหม่</strong></a> <a class="ring-1 ring-slate-900/5 space-y-3 hover:bg-sky-500 hover:ring-sky-500" href="javascript:;" onclick="addNewMessage(' + page + ');"><strong>+ เพิ่มข้อความใหม่</strong></a></div> </div>' +
                    "</div>" +
                    "</div></div>" +
                    '<div class="footer-text"><input class="w-full  py-2 border border-slate-300" autocomplete="off" name="textfooter[' + tmp_page + ']"  id="textfooter[' + tmp_page + ']"  onblur="checkVal(this)" /></div>' +
                    '<div ></div>' +
                    "</page>";
                $("#block_tab_1 #addPage").before(html);
                addPages(tmp_page);
            } else {
                alert('กรุณาเพิ่มเนื้อหาก่อน')
            }



        }


        function deleteVal(obj) {
            var message = $(obj).val();
            var nameValue = $(obj).attr("name");
            var page = $(obj).attr("data-page");
            var id = $(obj).attr("data-id");
            $('#' + id).parent().remove();
            deleteObject(page, id)
        }

        function deleteValuePage(obj) {
            var page = $(obj).attr("data-page");
            $('#page' + page).remove();
            deletePageAndUpdateSessionStorage(page)
        }

        function checkVal(obj) {
            var message = $(obj).val();
            var nameValue = $(obj).attr("name");
            var page = $(obj).attr("data-page");
            var id = $(obj).attr("id");
            updateMessages(page, id, message);

        }

        function changeThaiNumber(num) {
            var array = {
                1: "๑",
                2: "๒",
                3: "๓",
                4: "๔",
                5: "๕",
                6: "๖",
                7: "๗",
                8: "๘",
                9: "๙",
                0: "๐",
            };
            var str = num.toString();
            for (var val in array) {
                str = str.split(val).join(array[val]);
            }
            return str;
        }

    </script>

</body>

</html>